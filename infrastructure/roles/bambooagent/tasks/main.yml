---
  - name: kill existing java instances
    command: pkill -9 java
    ignore_errors: yes

  - name: Add EPEL repository
    yum:
      name: http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-9.noarch.rpm
      state: present

  - name: install useful packages
    yum:
      name: wget,elinks,telnet,htop,mlocate,python-pip,vim,nano,jq,java-1.8.0-openjdk-devel,unzip,maven,libunwind,libicu,git

  - name: download .NET Core
    get_url:
          url: "{{dot_net_download}}"
          dest: /tmp/dotnet.tar.gz
          mode: 0440

  - name: create dotnet directory
    file:
        path: /opt/dotnet
        state: directory

  - name: extract dotnet
    unarchive:
        src: /tmp/dotnet.tar.gz
        dest: /opt/dotnet
        copy: no

  - name: link dotnet
    file:
      src: /opt/dotnet/dotnet
      dest: /usr/local/bin/dotnet
      state: link

  - name: install mono key
    get_url:
        url: http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
        dest: /tmp/GPG-KEY-mono
        mode: 0440

  - name: import mono key
    rpm_key:
      state: present
      key: /tmp/GPG-KEY-mono

  - name: Add mono repo
    yum_repository:
      name: mono
      description: Mono repository
      baseurl: http://download.mono-project.com/repo/centos7/
      gpgkey: http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
      gpgcheck: yes
      enabled: yes

  - name: install mono
    yum:
      name: mono-devel

  - name: Set JAVA_HOME
    lineinfile: dest=/etc/environment state=present regexp='^JAVA_HOME' line='JAVA_HOME=/usr/lib/jvm/jre-1.8.0'

  - name: create agent home dir
    file:
        path: /root/bamboo-agent-home
        state: directory

  - name: create agent home dir
    file:
        path: /root/bamboo-agent-home/bin
        state: directory

  - name: set agent capabilities
    template:
      src: bamboo-capabilities.properties
      dest: /root/bamboo-agent-home/bin/bamboo-capabilities.properties
      mode: 0644

  - name: add launching script
    template:
      src: runagent.sh
      dest: /opt/runagent.sh
      mode: 0755

  - name: get bamboo agent JAR
    get_url:
        url: https://s3.amazonaws.com/bamboo-support/atlassian-bamboo-agent-installer-6.0.0.jar
        dest: /opt/atlassian-bamboo-agent-installer-6.0.0.jar
        mode: 0440

  - name: download octopus cli
    get_url:
        url: "{{octopus_cli_download}}"
        dest: /tmp/octopus-tools.tar.gz
        mode: 0440

  - name: create octopus cli directory
    file:
        path: /opt/octocli
        state: directory

  - name: extract octopus cli
    unarchive:
        src: /tmp/octopus-tools.tar.gz
        dest: /opt/octocli
        copy: no

  - name: download maven
    get_url:
       url: "{{maven_download}}"
       dest: /tmp/maven.tar.gz
       mode: 0440

  - name: extract maven cli
    unarchive:
        src: /tmp/maven.tar.gz
        dest: /opt
        copy: no

  - name: start agent
    shell: "nohup java -jar /opt/atlassian-bamboo-agent-installer-6.0.0.jar {{bamboo_server}} &"